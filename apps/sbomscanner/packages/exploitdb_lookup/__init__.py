import json
import logging

import requests


class ExploitDBLookup:
    def __init__(self):
        self.proxysrv = ""
        self.exploitdb = "https://www.exploit-db.com"

    def get_exploitdb_links(self, cve):
        if not cve or cve == "na":
            return []

        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3",
            "Accept": "application/json",
            "X-Requested-With": "XMLHttpRequest",
        }

        response = requests.get(
            f"{self.exploitdb}/search?cve={cve}",
            headers=headers,
            proxies={"http": self.proxysrv, "https": self.proxysrv},
        )

        if response.text:
            response_json = json.loads(response.text)
            exploit_ids = [
                item.get("id") for item in response_json["data"] if "id" in item
            ]
            exploit_ids = list(set(exploit_ids))

            links = [
                f"{self.exploitdb}/exploits/{exploit_id}" for exploit_id in exploit_ids
            ]
            return links
        else:
            logging.info("No data returned from the request")
            return []
